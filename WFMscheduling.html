<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Call Center WFM Scheduler</title>
   <style>
       :root {
           --primary: #2563eb;
           --secondary: #475569;
           --bg: #f8fafc;
           --surface: #ffffff;
           --border: #e2e8f0;
           --success: #dcfce7;
           --success-text: #166534;
           --danger: #fee2e2;
           --danger-text: #991b1b;
       }


       body {
           font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
           background-color: var(--bg);
           color: #1e293b;
           margin: 0;
           padding: 20px;
           line-height: 1.5;
       }


       .container {
           max-width: 1400px;
           margin: 0 auto;
       }


       /* Header & Controls */
       header {
           background: var(--surface);
           padding: 20px;
           border-radius: 8px;
           box-shadow: 0 1px 3px rgba(0,0,0,0.1);
           margin-bottom: 20px;
           display: flex;
           justify-content: space-between;
           align-items: center;
           flex-wrap: wrap;
           gap: 20px;
       }


       h1 { margin: 0; font-size: 1.5rem; color: #0f172a; }
      
       .settings-grid {
           display: flex;
           gap: 20px;
           align-items: end;
       }


       .input-group {
           display: flex;
           flex-direction: column;
       }


       label { font-size: 0.85rem; font-weight: 600; color: var(--secondary); margin-bottom: 4px; }
      
       input[type="number"] {
           padding: 8px 12px;
           border: 1px solid var(--border);
           border-radius: 6px;
           width: 100px;
           font-size: 1rem;
       }


       button.btn-primary {
           background-color: var(--primary);
           color: white;
           border: none;
           padding: 10px 24px;
           border-radius: 6px;
           font-weight: 600;
           cursor: pointer;
           transition: background 0.2s;
       }


       button.btn-primary:hover { background-color: #1d4ed8; }


       /* Tabs */
       .tabs {
           display: flex;
           gap: 10px;
           margin-bottom: 15px;
       }


       .tab-btn {
           padding: 10px 20px;
           background: #e2e8f0;
           border: none;
           border-radius: 6px;
           cursor: pointer;
           font-weight: 600;
           color: #64748b;
       }


       .tab-btn.active {
           background: var(--primary);
           color: white;
       }


       /* Data Grids */
       .card {
           background: var(--surface);
           padding: 20px;
           border-radius: 8px;
           box-shadow: 0 1px 3px rgba(0,0,0,0.1);
           overflow-x: auto;
           margin-bottom: 30px;
       }


       .grid-container {
           display: none;
       }
       .grid-container.active {
           display: block;
       }


       table {
           width: 100%;
           border-collapse: collapse;
           font-size: 0.9rem;
       }


       th, td {
           border: 1px solid var(--border);
           padding: 8px;
           text-align: center;
           white-space: nowrap;
       }


       th {
           background-color: #f1f5f9;
           font-weight: 600;
           color: #334155;
           position: sticky;
           top: 0;
           z-index: 10;
       }


       /* Input Table specific */
       .data-input {
           width: 100%;
           border: none;
           text-align: center;
           background: transparent;
           font-family: inherit;
           outline: none;
       }
       .data-input:focus {
           background-color: #e0f2fe;
           font-weight: bold;
       }


       /* Setup Table Specific */
       .setup-input {
           width: 100%;
           border: 1px solid #e2e8f0;
           border-radius: 4px;
           padding: 6px;
           text-align: center;
           font-family: inherit;
           min-width: 60px;
       }
       .setup-input:focus {
           border-color: var(--primary);
           outline: none;
           background-color: #eff6ff;
       }
      
       .pto-checkbox-group {
           display: flex;
           gap: 4px;
           justify-content: center;
           font-size: 0.75rem;
           flex-wrap: wrap;
           max-width: 250px;
       }
       .pto-label {
           display: flex;
           flex-direction: column;
           align-items: center;
           cursor: pointer;
           padding: 2px;
           background: #f1f5f9;
           border-radius: 4px;
       }


       /* Heatmap output */
       .heat-low { background-color: #dcfce7; color: #14532d; }
       .heat-med { background-color: #fef9c3; color: #713f12; }
       .heat-high { background-color: #fee2e2; color: #7f1d1d; }


       /* Gap output */
       .gap-surplus { background-color: #d1fae5; color: #047857; font-weight: bold; }
       .gap-short { background-color: #fee2e2; color: #b91c1c; font-weight: bold; }
       .gap-exact { background-color: #f3f4f6; color: #9ca3af; }


       .summary-row td {
           font-weight: bold;
           background-color: #f8fafc;
           border-top: 2px solid #cbd5e1;
       }
      
       /* Roster specific */
       .shift-cell {
           background-color: #eff6ff;
           color: #1e3a8a;
           border-radius: 4px;
           font-size: 0.95em;
           padding: 6px;
           font-weight: 600;
       }
       .off-day {
           background-color: #f1f5f9;
           color: #94a3b8;
           font-style: italic;
       }
       .pto-day {
           background-color: #fef2f2;
           color: #991b1b;
           font-weight: bold;
           border: 1px dashed #fca5a5;
       }


       .help-text {
           font-size: 0.9rem;
           color: #64748b;
           margin-bottom: 15px;
           background: #fff;
           padding: 15px;
           border-left: 4px solid var(--primary);
           border-radius: 4px;
       }
   </style>
</head>
<body>


<div class="container">
   <header>
       <div style="width: 100%;">
           <div style="display:flex; justify-content:space-between; align-items:center;">
               <div>
                   <h1>WFM Staffing Calculator</h1>
                   <p style="margin: 0; color: #64748b; font-size: 0.9rem;">Agent Setup &rarr; Call Volume &rarr; Schedule</p>
               </div>
               <button class="btn-primary" onclick="calculateSchedule()">Calculate Schedule</button>
           </div>


           <div class="settings-grid" style="margin-top: 15px;">
               <div class="input-group">
                   <label>SLA Target (%)</label>
                   <input type="number" id="slaTarget" value="80" min="1" max="100">
               </div>
               <div class="input-group">
                   <label>Target Time (Sec)</label>
                   <input type="number" id="targetTime" value="20" min="1">
               </div>
               <div class="input-group">
                   <label>Wrap-Up Buffer (Sec)</label>
                   <input type="number" id="wrapBuffer" value="10">
               </div>
               <div class="input-group">
                   <label>Global AHT (Sec)</label>
                   <input type="number" id="globalAHT" value="180">
               </div>
               <div class="input-group">
                   <label style="color:#0f172a">Shrinkage (%)</label>
                   <input type="number" id="shrinkage" value="10" min="0" max="50" style="border-color:#94a3b8">
               </div>
               <div class="input-group">
                   <label style="color:#0f172a">Agent Count</label>
                   <input type="number" id="agentCount" value="14" min="1" style="border-color:#94a3b8" onchange="renderSetupTable()">
               </div>
           </div>
       </div>
   </header>


   <div class="help-text">
       <strong>Workflow:</strong>
       1. <strong>Agent Setup:</strong> Paste Names and <strong>Previous Week's Schedule</strong> (Sun-Sat).
       2. <strong>Input:</strong> Paste your forecasted Call Volumes.
       3. <strong>Calculate:</strong> The tool uses the previous schedule to maintain consistency and check the Saturday-to-Sunday rest gap.
   </div>


   <div class="tabs">
       <button class="tab-btn active" onclick="switchTab('setup')">1. Agent Setup</button>
       <button class="tab-btn" onclick="switchTab('input')">2. Input: Call Volumes</button>
       <button class="tab-btn" onclick="switchTab('output')">3. Requirements</button>
       <button class="tab-btn" onclick="switchTab('roster')">4. Roster (Start Times)</button>
       <button class="tab-btn" onclick="switchTab('gap')">5. Coverage Gap</button>
   </div>


   <!-- SETUP GRID -->
   <div id="setup-view" class="grid-container active card">
       <h3>Agent Setup (Previous Period & PTO)</h3>
       <p style="font-size:0.9em; color:#64748b;">
           <strong>Paste Instructions:</strong> Copy 8 columns from Excel: <code>Name, Sun, Mon, Tue, Wed, Thu, Fri, Sat</code> (Previous Week).<br>
           Use <code>OFF</code> or leave blank for days off. Time format: <code>9</code>, <code>09:00</code>, <code>2 PM</code>.
       </p>
       <div style="overflow-x:auto;">
           <table id="setupTable">
               <thead>
                   <tr>
                       <th style="min-width:150px;">Agent Name</th>
                       <th style="min-width:60px;">Prev<br>Sun</th>
                       <th style="min-width:60px;">Prev<br>Mon</th>
                       <th style="min-width:60px;">Prev<br>Tue</th>
                       <th style="min-width:60px;">Prev<br>Wed</th>
                       <th style="min-width:60px;">Prev<br>Thu</th>
                       <th style="min-width:60px;">Prev<br>Fri</th>
                       <th style="min-width:60px;">Prev<br>Sat</th>
                       <th style="min-width:200px;">Planned PTO (Next Week)<br><span style="font-weight:normal; font-size:0.8em">Select days UNAVAILABLE</span></th>
                   </tr>
               </thead>
               <tbody id="setupTableBody">
                   <!-- JS Generates this -->
               </tbody>
           </table>
       </div>
   </div>


   <!-- INPUT GRID -->
   <div id="input-view" class="grid-container card">
       <h3>Next Week Call Volume Input (Start: Sunday)</h3>
       <table id="inputTable">
           <thead>
               <tr>
                   <th>Hour</th>
                   <th>Sunday</th>
                   <th>Monday</th>
                   <th>Tuesday</th>
                   <th>Wednesday</th>
                   <th>Thursday</th>
                   <th>Friday</th>
                   <th>Saturday</th>
               </tr>
           </thead>
           <tbody id="inputTableBody">
               <!-- JS Generates this -->
           </tbody>
       </table>
   </div>


   <!-- OUTPUT GRID -->
   <div id="output-view" class="grid-container card">
       <h3>Required Agents (Including Shrinkage)</h3>
       <p style="font-size:0.9em; color:#64748b;">Target headcount based on Erlang C + Shrinkage buffer.</p>
       <table id="outputTable">
           <thead>
               <tr>
                   <th>Hour</th>
                   <th>Sunday</th>
                   <th>Monday</th>
                   <th>Tuesday</th>
                   <th>Wednesday</th>
                   <th>Thursday</th>
                   <th>Friday</th>
                   <th>Saturday</th>
               </tr>
           </thead>
           <tbody id="outputTableBody">
               <!-- JS Generates this -->
           </tbody>
           <tfoot id="outputSummary"></tfoot>
       </table>
   </div>


   <!-- ROSTER GRID -->
   <div id="roster-view" class="grid-container card">
       <h3>Final Schedule (Start Times)</h3>
       <p style="font-size:0.9em; color:#64748b;">
           Shows <strong>Shift Start Time</strong> (8 hour shifts).<br>
           Algorithm prioritizes keeping the <i>Previous Schedule</i> unless 12h rest rule is violated.
       </p>
       <table id="rosterTable">
           <thead>
               <tr>
                   <th>Agent Name</th>
                   <th>Sunday</th>
                   <th>Monday</th>
                   <th>Tuesday</th>
                   <th>Wednesday</th>
                   <th>Thursday</th>
                   <th>Friday</th>
                   <th>Saturday</th>
                   <th>Scheduled Hours</th>
               </tr>
           </thead>
           <tbody id="rosterTableBody">
               <!-- JS Generates this -->
           </tbody>
       </table>
   </div>


   <!-- COVERAGE GAP GRID -->
   <div id="gap-view" class="grid-container card">
       <h3>Coverage Over/Under</h3>
       <table id="gapTable">
           <thead>
               <tr>
                   <th>Hour</th>
                   <th>Sunday</th>
                   <th>Monday</th>
                   <th>Tuesday</th>
                   <th>Wednesday</th>
                   <th>Thursday</th>
                   <th>Friday</th>
                   <th>Saturday</th>
               </tr>
           </thead>
           <tbody id="gapTableBody">
               <!-- JS Generates this -->
           </tbody>
       </table>
   </div>
</div>


<script>
   const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
   const daysShort = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
   const hours = Array.from({length: 24}, (_, i) => i);


   let globalRequirements = null;
   let globalRoster = [];
   // Store setup data
   let agentSetupData = [];


   function init() {
       renderSetupTable();
       renderInputTable();
   }


   function formatTime(h) {
       return h < 12 ? (h === 0 ? '12 AM' : h + ' AM') : (h === 12 ? '12 PM' : (h - 12) + ' PM');
   }


   // --- PARSER FOR PASTED TIMES ---
   function parseTimeInput(str) {
       if(!str) return -1;
       str = str.toString().toLowerCase().trim();
       // Explicitly handle "off" or "pto" as -1 (Not working)
       if(str === '' || str === 'off' || str === 'pto' || str === 'null' || str === '-') return -1;


       // Check for specific AM/PM formats
       const ampmMatch = str.match(/(\d{1,2})(?::(\d{2}))?\s*([ap]m)/);
       if(ampmMatch) {
           let h = parseInt(ampmMatch[1]);
           const ampm = ampmMatch[3];
           if(ampm === 'pm' && h < 12) h += 12;
           if(ampm === 'am' && h === 12) h = 0;
           return h;
       }
      
       // Check for 24h format with colon "14:00"
       const colonMatch = str.match(/(\d{1,2}):(\d{2})/);
       if(colonMatch) {
           return parseInt(colonMatch[1]);
       }


       // Fallback: simple number check (0-23)
       const num = parseInt(str);
       if(!isNaN(num) && num >= 0 && num <= 23) {
           return num;
       }
      
       return -1;
   }


   // --- SETUP TABLE LOGIC ---
   function renderSetupTable() {
       const count = parseInt(document.getElementById('agentCount').value) || 14;
       const tbody = document.getElementById('setupTableBody');
      
       const oldData = collectSetupData();
       tbody.innerHTML = '';


       for(let i=1; i<=count; i++) {
           const tr = document.createElement('tr');
          
           // Col 0: Agent Name
           const tdName = document.createElement('td');
           const nameInput = document.createElement('input');
           nameInput.type = 'text';
           nameInput.className = 'setup-input';
           nameInput.style.textAlign = 'left';
           nameInput.value = (oldData[i] && oldData[i].name) ? oldData[i].name : `Agent ${i}`;
           nameInput.dataset.col = 0;
           nameInput.dataset.row = i;
           nameInput.addEventListener('paste', handleSetupPaste);
           tdName.appendChild(nameInput);
           tr.appendChild(tdName);


           // Cols 1-7: Previous Week (Sun-Sat)
           for(let d=0; d<7; d++) {
               const tdSched = document.createElement('td');
               const timeInput = document.createElement('input');
               timeInput.type = 'text';
               timeInput.className = 'setup-input';
               // Placeholder only on Sunday to save space visual
               if(d===0 && i===1) timeInput.placeholder = "9 AM";
              
               timeInput.dataset.col = d + 1; // 1 to 7
               timeInput.dataset.row = i;
               timeInput.addEventListener('paste', handleSetupPaste);
              
               // Restore val
               if(oldData[i] && oldData[i].prevScheduleStr && oldData[i].prevScheduleStr[d] !== undefined) {
                   timeInput.value = oldData[i].prevScheduleStr[d];
               }
               tdSched.appendChild(timeInput);
               tr.appendChild(tdSched);
           }


           // Col 8: PTO Checkboxes
           const tdPto = document.createElement('td');
           const group = document.createElement('div');
           group.className = 'pto-checkbox-group';
          
           daysShort.forEach((d, idx) => {
               const label = document.createElement('label');
               label.className = 'pto-label';
               const box = document.createElement('input');
               box.type = 'checkbox';
               box.id = `agent-pto-${i}-${idx}`; // Agent-Day
              
               // Restore val
               if(oldData[i] && oldData[i].pto && oldData[i].pto.includes(idx)) {
                   box.checked = true;
               }


               label.appendChild(box);
               label.appendChild(document.createTextNode(d));
               group.appendChild(label);
           });
           tdPto.appendChild(group);
           tr.appendChild(tdPto);


           tbody.appendChild(tr);
       }
   }


   function handleSetupPaste(e) {
       e.preventDefault();
       const clipboardData = e.clipboardData || window.clipboardData;
       const pastedData = clipboardData.getData('Text');
      
       const rows = pastedData.trim().split(/\r\n|\n|\r/);
       const startInput = e.target;
       const startRow = parseInt(startInput.dataset.row);
       const startCol = parseInt(startInput.dataset.col);


       rows.forEach((row, rIndex) => {
           const cells = row.split(/\t/);
           cells.forEach((cellVal, cIndex) => {
               const targetRowIdx = startRow + rIndex;
               const targetColIdx = startCol + cIndex;


               // Valid inputs are 0 (Name) to 7 (Sat)
               if (targetColIdx <= 7) {
                   const input = document.querySelector(`input.setup-input[data-row="${targetRowIdx}"][data-col="${targetColIdx}"]`);
                   if (input) {
                       input.value = cellVal.trim();
                   }
               }
           });
       });
   }


   function collectSetupData() {
       const data = {};
       const count = parseInt(document.getElementById('agentCount').value) || 0;
      
       for(let i=1; i<=count; i++) {
           // Find Name Input
           const nameInput = document.querySelector(`input.setup-input[data-row="${i}"][data-col="0"]`);
           if(!nameInput) continue;


           const prevSchedule = [];
           const prevScheduleStr = [];


           for(let d=1; d<=7; d++) {
               const tInput = document.querySelector(`input.setup-input[data-row="${i}"][data-col="${d}"]`);
               const val = tInput ? tInput.value : "";
               prevScheduleStr.push(val);
               prevSchedule.push(parseTimeInput(val));
           }


           const ptoDays = [];
           for(let d=0; d<7; d++) {
               const box = document.getElementById(`agent-pto-${i}-${d}`);
               if(box && box.checked) ptoDays.push(d);
           }
          
           data[i] = {
               id: i,
               name: nameInput.value,
               prevScheduleStr: prevScheduleStr,
               prevSchedule: prevSchedule,
               pto: ptoDays
           };
       }
       return data;
   }


   function renderInputTable() {
       const tbody = document.getElementById('inputTableBody');
       tbody.innerHTML = '';
       hours.forEach(hour => {
           const tr = document.createElement('tr');
           const tdHour = document.createElement('td');
           tdHour.textContent = formatTime(hour);
           tdHour.style.fontWeight = 'bold';
           tdHour.style.backgroundColor = '#f8fafc';
           tr.appendChild(tdHour);


           days.forEach((day, dayIndex) => {
               const td = document.createElement('td');
               const input = document.createElement('input');
               input.type = 'text';
               input.className = 'data-input';
               input.dataset.day = dayIndex;
               input.dataset.hour = hour;
               input.value = 0;
               input.addEventListener('paste', handlePaste);
               td.appendChild(input);
               tr.appendChild(td);
           });
           tbody.appendChild(tr);
       });
   }


   function handlePaste(e) {
       e.preventDefault();
       const clipboardData = e.clipboardData || window.clipboardData;
       const pastedData = clipboardData.getData('Text');
       const rows = pastedData.trim().split(/\r\n|\n|\r/);
       const startInput = e.target;
       const startRow = parseInt(startInput.dataset.hour);
       const startCol = parseInt(startInput.dataset.day);


       rows.forEach((row, rIndex) => {
           const cells = row.split(/\t/);
           cells.forEach((cellVal, cIndex) => {
               const targetRow = startRow + rIndex;
               const targetCol = startCol + cIndex;
               if (targetRow < 24 && targetCol < 7) {
                   const input = document.querySelector(`input[data-hour="${targetRow}"][data-day="${targetCol}"]`);
                   if (input) input.value = cellVal.trim();
               }
           });
       });
   }


   function switchTab(tabName) {
       document.querySelectorAll('.grid-container').forEach(el => el.classList.remove('active'));
       document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
       const tabMap = { 'setup':0, 'input': 1, 'output': 2, 'roster': 3, 'gap': 4 };
       document.getElementById(tabName + '-view').classList.add('active');
       document.querySelectorAll('.tab-btn')[tabMap[tabName]].classList.add('active');
   }


   // --- ERLANG C ---
   function calculateErlangC(callsPerHour, ahtSeconds, targetSLPercent, targetTimeSeconds) {
       if (callsPerHour <= 0) return 0;
       const trafficIntensity = (callsPerHour * ahtSeconds) / 3600;
       let agents = Math.floor(trafficIntensity) + 1;
       let serviceLevel = 0;
       let maxIterations = 200;
       while (serviceLevel < targetSLPercent && maxIterations > 0) {
           let sumN = 0;
           for (let i = 0; i < agents; i++) { sumN += Math.pow(trafficIntensity, i) / factorial(i); }
           const erlangB_part = (Math.pow(trafficIntensity, agents) / factorial(agents)) * (agents / (agents - trafficIntensity));
           const Pw = erlangB_part / (sumN + erlangB_part);
           serviceLevel = (1 - (Pw * Math.exp(-(agents - trafficIntensity) * (targetTimeSeconds / ahtSeconds)))) * 100;
           if (serviceLevel < targetSLPercent) agents++;
           maxIterations--;
       }
       return agents;
   }
   function factorial(n) {
       if (n === 0 || n === 1) return 1;
       let res = 1; for (let i = 2; i <= n; i++) res *= i; return res;
   }


   // --- MAIN CALCULATION ---
   function calculateSchedule() {
       const setupMap = collectSetupData();
      
       const slaTarget = parseFloat(document.getElementById('slaTarget').value);
       const targetTime = parseFloat(document.getElementById('targetTime').value);
       const globalAHT = parseFloat(document.getElementById('globalAHT').value);
       const wrapBuffer = parseFloat(document.getElementById('wrapBuffer').value);
       const totalAHT = globalAHT + wrapBuffer;
       const shrinkage = parseFloat(document.getElementById('shrinkage').value) || 0;


       const tbody = document.getElementById('outputTableBody');
       const tfoot = document.getElementById('outputSummary');
       tbody.innerHTML = '';
       tfoot.innerHTML = '';


       globalRequirements = Array.from({length: 7}, () => new Array(24).fill(0));
       let dailyHoursTotal = new Array(7).fill(0);


       hours.forEach(hour => {
           const tr = document.createElement('tr');
           const tdHour = document.createElement('td');
           tdHour.textContent = formatTime(hour);
           tdHour.style.fontWeight = 'bold';
           tr.appendChild(tdHour);


           days.forEach((_, dayIndex) => {
               const input = document.querySelector(`input[data-hour="${hour}"][data-day="${dayIndex}"]`);
               const calls = parseFloat(input.value) || 0;
               let requiredAgents = calculateErlangC(calls, totalAHT, slaTarget, targetTime);
              
               if (requiredAgents > 0 && shrinkage > 0) {
                   requiredAgents = Math.ceil(requiredAgents / (1 - (shrinkage / 100)));
               }


               globalRequirements[dayIndex][hour] = requiredAgents;
               dailyHoursTotal[dayIndex] += requiredAgents;


               const td = document.createElement('td');
               td.textContent = requiredAgents;
               if (requiredAgents > 10) td.className = 'heat-high';
               else if (requiredAgents > 5) td.className = 'heat-med';
               else if (requiredAgents > 0) td.className = 'heat-low';
               tr.appendChild(td);
           });
           tbody.appendChild(tr);
       });


       const trSum = document.createElement('tr');
       trSum.className = 'summary-row';
       trSum.innerHTML = '<td>Total Hours Needed</td>' + dailyHoursTotal.map(t => `<td>${t}</td>`).join('');
       tfoot.appendChild(trSum);


       generateRoster(setupMap);
       switchTab('roster');
   }


   // --- ROSTER GENERATION ---
   function generateRoster(setupMap) {
       if (!globalRequirements) return;
       const SHIFT_LENGTH = 8;
       const MIN_REST = 12;
      
       let unmetDemand = globalRequirements.map(row => [...row]);
       let roster = [];
      
       const agentIDs = Object.keys(setupMap).sort((a,b) => a-b);


       agentIDs.forEach(id => {
           const settings = setupMap[id];
          
           let agent = {
               id: settings.id,
               name: settings.name,
               shifts: {},
               totalHours: 0
           };


           // 1. Identify "Non-PTO" Days
           const availableDays = [];
           for(let d=0; d<7; d++) {
               if(!settings.pto.includes(d)) availableDays.push(d);
           }


           // 2. Identify Work Days vs OFF Days
           // Rule: Must have 1 OFF day from the Available Days (Non-PTO).
           // Example: If PTO is 1 day, Available is 6. We select 1 to be OFF. Work = 5. Total Commit = 6.
           // Exception: If PTO >= 7, 0 available.
          
           let daysToWork = [...availableDays];
           if(availableDays.length > 0) {
               // We MUST remove at least 1 day to be the "OFF" day
              
               let offDay = -1;
              
               // Priority A: Stick to Previous Week's OFF day if possible
               // Check prevSchedule for -1
               const prevOffIndices = [];
               settings.prevSchedule.forEach((t, idx) => {
                   if(t === -1) prevOffIndices.push(idx);
               });
              
               // See if any previous off days are available this week (not PTO)
               const candidates = prevOffIndices.filter(d => availableDays.includes(d));
              
               if(candidates.length > 0) {
                   offDay = candidates[0]; // Keep consistency
               } else {
                   // Priority B: Drop lowest demand day
                   let daySums = availableDays.map(d => {
                       return { day: d, sum: unmetDemand[d].reduce((a,b)=>a+b, 0) };
                   });
                   daySums.sort((a,b) => a.sum - b.sum);
                   offDay = daySums[0].day;
               }
              
               // Set Work Days
               daysToWork = availableDays.filter(d => d !== offDay);
           }


           // 3. DETERMINE START TIME (Stickiness)
           let freqMap = {};
           let maxFreq = 0;
           let preferredStart = -1;
          
           settings.prevSchedule.forEach(t => {
               if(t !== -1) {
                   freqMap[t] = (freqMap[t] || 0) + 1;
                   if(freqMap[t] > maxFreq) {
                       maxFreq = freqMap[t];
                       preferredStart = t;
                   }
               }
           });


           const prevSat = settings.prevSchedule[6];
           let forcedStart = -1;


           if(preferredStart !== -1) {
               let isSafe = true;
               if(prevSat !== -1) {
                   // Constraint: SunStart >= PrevSatStart - 4
                   if(preferredStart < prevSat - 4) isSafe = false;
               }
               if(isSafe) forcedStart = preferredStart;
           }


           let bestStartHour = (forcedStart !== -1) ? forcedStart : 0;
          
           if(forcedStart === -1) {
                let maxCovered = -Infinity;
                let minStart = 0;
                if(prevSat !== -1) minStart = Math.max(0, prevSat - 4);


                for (let h = minStart; h < 24; h++) {
                   let weeklyScore = 0;
                   daysToWork.forEach(d => {
                       for (let s = 0; s < SHIFT_LENGTH; s++) {
                           let hourIdx = (h + s) % 24;
                           let dayIdx = (h + s >= 24) ? (d + 1)%7 : d;
                           if(unmetDemand[dayIdx][hourIdx] > 0) weeklyScore++;
                       }
                   });
                   if(weeklyScore > maxCovered) {
                       maxCovered = weeklyScore;
                       bestStartHour = h;
                   }
                }
           }


           daysToWork.forEach(d => {
               agent.shifts[d] = bestStartHour;
               agent.totalHours += SHIFT_LENGTH;
               for (let s = 0; s < SHIFT_LENGTH; s++) {
                   let hourIdx = (bestStartHour + s) % 24;
                   let dayIdx = (bestStartHour + s >= 24) ? (d + 1)%7 : d;
                   unmetDemand[dayIdx][hourIdx]--;
               }
           });


           roster.push(agent);
       });
      
       globalRoster = roster;
       renderRoster(roster);
       renderCoverageGap();
   }


   function renderRoster(roster) {
       const tbody = document.getElementById('rosterTableBody');
       tbody.innerHTML = '';


       if (roster.length === 0) {
           tbody.innerHTML = '<tr><td colspan="9">No data. Calculate staffing first.</td></tr>';
           return;
       }


       const setupMap = collectSetupData();


       roster.forEach(agent => {
           const tr = document.createElement('tr');
          
           const tdName = document.createElement('td');
           tdName.textContent = agent.name;
           tdName.style.fontWeight = 'bold';
           tr.appendChild(tdName);


           days.forEach((_, dIndex) => {
               const td = document.createElement('td');
               const isPTO = setupMap[agent.id] && setupMap[agent.id].pto.includes(dIndex);
              
               if (isPTO) {
                   td.textContent = 'PTO';
                   td.className = 'pto-day';
               } else if (agent.shifts[dIndex] !== undefined) {
                   const startHour = agent.shifts[dIndex];
                   td.innerHTML = `<div class="shift-cell">${formatTime(startHour)}</div>`;
               } else {
                   td.textContent = 'OFF';
                   td.className = 'off-day';
               }
               tr.appendChild(td);
           });


           const tdTotal = document.createElement('td');
           tdTotal.textContent = agent.totalHours;
           // Removed low-hour warning red text since logic is now strict 6-day (with PTO included)
           tr.appendChild(tdTotal);


           tbody.appendChild(tr);
       });
   }


   function renderCoverageGap() {
       if (!globalRequirements || !globalRoster) return;
       const tbody = document.getElementById('gapTableBody');
       tbody.innerHTML = '';
       const SHIFT_LENGTH = 8;
       let scheduled = Array.from({length: 7}, () => new Array(24).fill(0));
      
       globalRoster.forEach(agent => {
           days.forEach((_, d) => {
               if (agent.shifts[d] !== undefined) {
                   let start = agent.shifts[d];
                   for (let s = 0; s < SHIFT_LENGTH; s++) {
                       let hourIdx = (start + s) % 24;
                       let dayIdx = (start + s >= 24) ? (d + 1)%7 : d;
                       scheduled[dayIdx][hourIdx]++;
                   }
               }
           });
       });


       hours.forEach(hour => {
           const tr = document.createElement('tr');
           const tdHour = document.createElement('td');
           tdHour.textContent = formatTime(hour);
           tdHour.style.fontWeight = 'bold';
           tr.appendChild(tdHour);


           days.forEach((_, dayIndex) => {
               const required = globalRequirements[dayIndex][hour];
               const actual = scheduled[dayIndex][hour];
               const gap = actual - required;


               const td = document.createElement('td');
               if (required === 0 && actual === 0) {
                    td.textContent = "-";
                    td.style.color = "#ccc";
               } else {
                   if (gap > 0) {
                       td.textContent = `+${gap}`;
                       td.className = 'gap-surplus';
                   } else if (gap < 0) {
                       td.textContent = gap;
                       td.className = 'gap-short';
                   } else {
                       td.textContent = "0";
                       td.className = 'gap-exact';
                   }
               }
               tr.appendChild(td);
           });
           tbody.appendChild(tr);
       });
   }


   window.onload = init;
</script>


</body>
</html>

